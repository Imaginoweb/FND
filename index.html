<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fnac Darty – Clienteling</title>
  <link rel="icon" href="https://static.publicocdn.com/files/site/assets/img/commercial/fnac-logo.png" />
  <style>
    :root{
      --brand:#000;
      --accent:#ffd200;
      --bg:#f6f6f6;
      --ink:#111;
      --muted:#6b7280;
      --card:#fff;
      --radius:18px;
      --shadow:0 8px 24px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:var(--bg); color:var(--ink);
      display:flex; align-items:center; justify-content:center;
    }
    .app{width:min(1280px, 96vw); height:min(820px, 92vh); background:#fff; border-radius:28px; box-shadow:var(--shadow); overflow:hidden; display:grid; grid-template-rows:84px 1fr; border:1px solid #e5e7eb;}
    .topbar{display:flex; align-items:center; gap:16px; padding:16px 20px; background:#fff; border-bottom:1px solid #eee;}
    .logo{height:44px}
    .searchwrap{margin-left:auto; display:flex; align-items:center; gap:10px; position:relative}
    .search{width:520px; max-width:64vw; height:44px; border:1.5px solid #ddd; border-radius:999px; padding:0 16px 0 48px; outline:none; font-size:16px; background:#fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>') no-repeat 14px center; transition:border-color .2s, box-shadow .2s}
    .search:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(255,210,0,.25)}
    .btn{height:44px; padding:0 14px; border-radius:999px; border:1.5px solid var(--brand); background:var(--brand); color:#fff; font-weight:600; cursor:pointer}
    .btn:hover{opacity:.9}
    .btn-secondary{background:#fff; color:var(--brand)}
    .suggest{position:absolute; top:70px; right:0; width:min(640px, 92vw); background:#fff; border:1px solid #eee; border-radius:16px; box-shadow:var(--shadow); overflow:hidden; display:none; z-index:1000}
    .s-item{padding:12px 14px; display:flex; gap:12px; align-items:center; cursor:pointer}
    .s-item:hover{background:#fafafa}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:var(--accent); color:#111; font-weight:700}
    .muted{color:var(--muted)}
    .layout{display:grid; grid-template-columns:1fr 1fr; gap:18px; padding:18px; height:100%;}
    .card{background:var(--card); border:1px solid #eee; border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); display:none}
    .card.show{display:block}
    .card h3{margin:0 0 12px; font-size:18px}
    .kv{display:grid; grid-template-columns:180px 1fr; gap:10px; align-items:center}
    .kv input, .kv select{height:38px; padding:0 10px; border:1px solid #e5e7eb; border-radius:10px; outline:none}
    .kv input[readonly]{background:#fafafa}
    .row{display:flex; gap:10px}
    .row .btn{height:36px}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{padding:10px 8px; border-bottom:1px solid #eee; text-align:left}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6}
    .empty{height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; color:var(--muted)}
    .empty svg{width:72px; height:72px}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none}
    .modal{position:fixed; inset:0; display:grid; place-items:center; pointer-events:none}
    .sheet{width:min(560px, 92vw); background:#fff; border-radius:20px; box-shadow:var(--shadow); padding:18px; transform:translateY(20px); opacity:0; transition:.2s}
    .modal.show{pointer-events:auto}
    .modal.show .modal-backdrop{display:block}
    .modal.show .sheet{transform:none; opacity:1}
    .sheet h3{margin:0 0 12px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid .full{grid-column:1 / -1}
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <img class="logo" src="https://static.publicocdn.com/files/site/assets/img/commercial/fnac-logo.png" alt="Fnac Darty" />
      <div class="searchwrap">
        <input id="q" class="search" placeholder="Rechercher par email, prénom, nom…" autocomplete="off" aria-expanded="false" />
        <button id="newBtn" class="btn">Nouveau contact</button>
        <div id="suggest" class="suggest"></div>
      </div>
    </header>
    <main class="layout">
      <section id="cardDetails" class="card"> ... </section>
      <section id="cardPurchases" class="card"> ... </section>
      <section id="emptyState" class="card show" style="grid-column:1/-1;text-align:center;display:block"> ... </section>
    </main>
  </div>
  <div id="modal" class="modal"> ... </div>
<script>
const BASE_URL='https://fnacdarty-demo.poc2.imagino.com/ucdapi/Exposition_RCU/V1';
const ENDPOINT=BASE_URL+'/RCU_Fnac_2';
const API_KEY='c92ad264-f863-4f56-8e9e-22da8f8450a1';
let cache=[],selected=null;
const $=s=>document.querySelector(s);
const show=(el,on=true)=>el.classList.toggle('show',on);
function closeSuggestions(){suggest.innerHTML='';suggest.style.display='none';q.setAttribute('aria-expanded','false');}
const enableEdit=(on)=>{['firstName','lastName','email','dob','city','zip','statutFid','statutRFM','magasinFav'].forEach(id=>{const i=document.getElementById(id);i.readOnly=!on;});['optinEmail','optinSMS','optinPush'].forEach(id=>{document.getElementById(id).disabled=!on;});$('#saveBtn').style.display=on?'inline-flex':'none';$('#editToggle').textContent=on?'Annuler':'Éditer';}
const norm=s=>(s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
async function apiGET(url){const r=await fetch(url,{headers:{'X-API-KEY':API_KEY}});if(!r.ok)throw new Error(await r.text());return r.json();}
async function apiPOST(url,payload){const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','X-API-KEY':API_KEY},body:JSON.stringify(payload)});if(!r.ok)throw new Error(await r.text());return r.json();}
async function ensureCache(){if(cache.length)return cache;const d=await apiGET(ENDPOINT+'?limit=1000');cache=(d&&d.data)?d.data:[];return cache;}
const q=$('#q'),suggest=$('#suggest'),searchwrap=document.querySelector('.searchwrap');
document.addEventListener('click',e=>{if(!searchwrap.contains(e.target))closeSuggestions();});
q.addEventListener('keydown',e=>{if(e.key==='Escape'){closeSuggestions();q.blur();}});
q.addEventListener('keydown',e=>{if(e.key==='Enter'&&suggest.style.display==='block'){const f=suggest.querySelector('.s-item');if(f)f.click();}});
q.addEventListener('input',async e=>{const term=norm(e.target.value);if(!term){closeSuggestions();return;}await ensureCache();const list=cache.filter(r=>norm(r.email).includes(term)||norm(r.firstName).includes(term)||norm(r.lastName).includes(term)).slice(0,20);renderSuggestions(list);});
function renderSuggestions(list){suggest.innerHTML='';if(!list.length){closeSuggestions();return;}list.forEach(r=>{const d=document.createElement('div');d.className='s-item';d.innerHTML=`<span class="badge">RCU</span><div style="flex:1"><div><strong>${r.firstName||''} ${r.lastName||''}</strong> · <span class="muted">${r.email||''}</span></div><div class="muted">${r.city||''} ${r.zipCode?('· '+r.zipCode):''}</div></div>`;d.addEventListener('click',()=>selectRecord(r));suggest.appendChild(d);});suggest.style.display='block';q.setAttribute('aria-expanded','true');}
function selectRecord(r){selected=r;closeSuggestions();$('#emptyState').style.display='none';show($('#cardDetails'),true);show($('#cardPurchases'),true);$('#firstName').value=r.firstName||'';$('#lastName').value=r.lastName||'';$('#email').value=r.email||'';$('#dob').value=r.dateOfBirth||'';$('#city').value=r.city||'';$('#zip').value=r.zipCode||'';$('#statutFid').value=r.Statut_Fidelite||'';$('#statutRFM').value=r.Statut_RFM||'';$('#magasinFav').value=r.Magasin_favori||'';$('#optinEmail').value=String(r.optInEmail===true);$('#optinSMS').value=String(r.optInSMS===true);$('#optinPush').value=String(r.optInPush===true);enableEdit(false);const tb=document.querySelector('#purchasesTable tbody');tb.innerHTML='';const arr=Array.isArray(r['3_derniers_produits_achetes'])?r['3_derniers_produits_achetes']:[];if(!arr.length){document.getElementById('emptyPurchases').style.display='flex';}else{document.getElementById('emptyPurchases').style.display='none';arr.forEach(p=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${p.Order_date?new Date(p.Order_date).toLocaleDateString():''}</td><td>${p.product_name||''}</td><td><span class='pill'>${p.brand||''}</span></td><td>${p.category||''}</td><td>${p.quantity??''}</td><td>${typeof p.line_total_ttc==='number'?(p.line_total_ttc.toFixed(2)+' €'):''}</td>`;tb.appendChild(tr);});}}
$('#editToggle').addEventListener('click',()=>{const editing=$('#saveBtn').style.display!=='none';enableEdit(!editing);});
$('#saveBtn').addEventListener('click',async()=>{if(!selected)return;try{const payload={email:$('#email').value,firstName:$('#firstName').value,lastName:$('#lastName').value,dateOfBirth:$('#dob').value||null,city:$('#city').value||null,zipCode:$('#zip').value||null,RFM:$('#statutRFM').value||null,optInEmail:$('#optinEmail').value==='true',optInSMS:$('#optinSMS').value==='true',optInPush:$('#optinPush').value==='true'};await apiPOST(ENDPOINT,payload);Object.assign(selected,payload);enableEdit(false);alert('Profil mis à jour.');}catch(e){alert('Échec de la mise à jour: '+e.message);}});
const modal=document.getElementById('modal');const openModal=(on)=>{modal.classList.toggle('show',!!on);}
$('#newBtn').addEventListener('click',()=>openModal(true));document.querySelector('.modal-backdrop').addEventListener('click',()=>openModal(false));$('#cancelNew').addEventListener('click',()=>openModal(false));
$('#createNew').addEventListener('click',async()=>{const payload={email:$('#n_email').value,firstName:$('#n_firstName').value,lastName:$('#n_lastName').value,mobile:$('#n_mobile').value||null,city:$('#n_city').value||null,zipCode:$('#n_zip').value||null,optInEmail:$('#n_optinEmail').value==='true',optInSMS:$('#n_optinSMS').value==='true'};if(!payload.email){alert('Email requis.');return;}try{await apiPOST(ENDPOINT,payload);cache.unshift(payload);openModal(false);q.value=payload.email;renderSuggestions([payload]);alert('Contact créé.');}catch(e){alert('Échec création: '+e.message);}});
</script>
</body>
</html>
