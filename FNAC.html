<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fnac Darty — Clienteling</title>
  <style>
    :root{
      --fnac-yellow:#FFD400; /* Fnac */
      --fnac-black:#000000;
      --darty-red:#E60012;   /* Darty */
      --ink:#0d0f14;
      --muted:#6b7280;
      --bg:#f6f7f9;
      --card:#ffffff;
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--ink)}
    .ipad{width:1366px;max-width:100vw;height:100vh;max-height:100vh;margin:auto;padding:20px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--fnac-yellow),#fff4a6)}
    .app{width:100%;height:100%;background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.15);display:flex;flex-direction:column}
    header{display:flex;align-items:center;gap:16px;padding:18px 22px;border-bottom:1px solid #e5e7eb}
    header .brand{display:flex;align-items:center;gap:12px}
    header .brand img{height:38px}
    .badge{font-weight:700;padding:4px 10px;border-radius:999px;background:var(--fnac-black);color:#fff}
    .right{margin-left:auto;display:flex;gap:16px;align-items:center;color:var(--muted);font-size:14px}
    .content{display:grid;grid-template-columns:380px 1fr;gap:20px;padding:20px;height:100%;overflow:hidden}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;display:flex;flex-direction:column;min-height:0;position:relative}
    .searchRow{display:flex;gap:10px;align-items:center}
    .searchRow input{flex:1;padding:14px;border:1px solid #d1d5db;border-radius:12px;font-size:16px}
    .searchRow .newBtn{white-space:nowrap;appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;background:var(--fnac-black);color:#fff}
    .suggestions{margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;overflow:auto;max-height:40vh}
    .suggestions div{padding:10px 12px;cursor:pointer}
    .suggestions div:hover{background:#f3f4f6}
    .sug-empty{padding:10px 12px;color:var(--muted)}
    .hidden{display:none}
    .group-title{font-weight:700;margin:16px 4px 8px;color:#111827}
    .field{display:flex;align-items:center;gap:10px;margin:8px 0}
    .field label{width:140px;color:#374151;font-size:14px}
    .field input,.field .ro{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa}
    .field input[readonly]{background:#f9fafb;color:#111827}
    .actions{display:flex;gap:10px;margin-top:auto}
    button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .primary{background:var(--fnac-black);color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .danger{background:var(--darty-red);color:#fff}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{grid-column:span 12;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;min-height:0}
    .card h3{margin:0 0 10px 0}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;font-size:14px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left;font-size:14px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .footer{padding:10px 16px;color:var(--muted);font-size:12px;border-top:1px solid #e5e7eb}

    /* Bubble (popover) */
    .bubble{position:absolute;top:64px;right:16px;width:360px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.15);padding:14px;z-index:10}
    .bubble:before{content:"";position:absolute;top:-10px;right:28px;border-width:0 10px 10px 10px;border-style:solid;border-color:transparent transparent #e5e7eb transparent}
    .bubble:after{content:"";position:absolute;top:-8px;right:28px;border-width:0 10px 10px 10px;border-style:solid;border-color:transparent transparent #fff transparent}
    .bubble h4{margin:4px 0 8px 0}

    /* Toast */
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 6px 18px rgba(0,0,0,.2);font-size:14px;z-index:50}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #e5e7eb;border-top-color:#111827;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="ipad">
    <div class="app" id="app">
      <header>
        <div class="brand">
          <!-- Your exact logo URL with graceful fallback -->
          <img id="logo" alt="Fnac Darty" src="https://static.publicocdn.com/files/site/assets/img/commercial/fnac-logo.png" onerror="this.onerror=null;this.src='https://upload.wikimedia.org/wikipedia/commons/0/0b/Fnac_Logo.svg'" />
          <span class="badge">Clienteling</span>
        </div>
        <div class="right">
          <span id="who">Conseiller·ère : —</span>
        </div>
      </header>

      <div class="content">
        <!-- LEFT: Search & profile -->
        <section class="panel" id="leftPanel">
          <div class="searchRow">
            <input id="q" type="text" placeholder="Rechercher par email (fnac/darty)" autocomplete="off" />
            <button id="btnNew" class="newBtn">Nouveau contact</button>
          </div>
          <div id="sug" class="suggestions"></div>

          <!-- Everything below stays hidden until a record is loaded -->
          <div id="leftBody" class="hidden">
            <div class="group-title">Profil</div>
            <div class="field"><label>Prénom</label><input id="firstName" readonly></div>
            <div class="field"><label>Nom</label><input id="lastName" readonly></div>
            <div class="field"><label>Email</label><input id="email" readonly></div>
            <div class="field"><label>Téléphone</label><input id="mobile" readonly></div>
            <div class="field"><label>Magasin favori</label><input id="favStore" class="ro" readonly></div>
            <div class="field"><label>Statut fidélité</label><input id="fid" class="ro" readonly></div>
            <div class="field"><label>RFM</label><input id="rfm" class="ro" readonly></div>
            <div class="field"><label>Opt-in Email</label><input id="optEmail" class="ro" readonly></div>
            <div class="field"><label>Opt-in SMS</label><input id="optSMS" class="ro" readonly></div>
            <div class="field"><label>Opt-in Push</label><input id="optPush" class="ro" readonly></div>

            <div class="actions">
              <button class="ghost" id="btnEdit">Modifier</button>
              <button class="primary" id="btnSave" style="display:none">Enregistrer</button>
              <button class="danger" id="btnCancel" style="display:none">Annuler</button>
            </div>
          </div>

          <!-- Create bubble -->
          <div id="createBubble" class="bubble hidden" role="dialog" aria-modal="true" aria-labelledby="bubbleTitle">
            <h4 id="bubbleTitle">Nouveau contact</h4>
            <div class="field"><label>Prénom</label><input id="cFirst"></div>
            <div class="field"><label>Nom</label><input id="cLast"></div>
            <div class="field"><label>Email</label><input id="cEmail"></div>
            <div class="field"><label>Mobile</label><input id="cMobile"></div>
            <div class="actions">
              <button class="primary" id="bubbleCreate">Créer</button>
              <button class="ghost" id="bubbleClose">Fermer</button>
            </div>
          </div>
        </section>

        <!-- RIGHT: Insights (hidden until a record is loaded) -->
        <section class="panel hidden" id="rightPanel" style="overflow:auto">
          <div class="grid">
            <div class="card" id="summary">
              <h3>Résumé client</h3>
              <div class="kv">
                <div>CA Omnicanal (€)</div><div id="ca">—</div>
                <div>Classification</div><div id="classif">—</div>
                <div>Ville</div><div id="city">—</div>
                <div>Code postal</div><div id="zip">—</div>
                <div>Date de naissance</div><div id="dob">—</div>
                <div>Store ID</div><div id="storeId">—</div>
              </div>
            </div>

            <div class="card" id="recent">
              <h3>3 derniers produits achetés</h3>
              <table class="table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Produit</th>
                    <th>Catégorie</th>
                    <th>Marque</th>
                    <th>Qté</th>
                    <th>Prix TTC</th>
                  </tr>
                </thead>
                <tbody id="purchases"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <div class="footer">Source: Imagino UCD API — Exposition_RCU/V1 / RCU_Fnac_2</div>
      <div id="toast" class="toast hidden"></div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const API_BASE = 'https://fnacdarty-demo.poc2.imagino.com/ucdapi/Exposition_RCU/V1';
    const API_KEY  = 'c92ad264-f863-4f56-8e9e-22da8f8450a1';

    document.getElementById('who').textContent = 'Conseiller·ère : Linda (Fnac Darty)';

    const $ = (id) => document.getElementById(id);
    const setRO = (on) => {
      ['firstName','lastName','email','mobile','favStore','fid','rfm','optEmail','optSMS','optPush']
        .forEach(id=>{ const el=$(id); el.readOnly=on; el.style.background= on? '#f9fafb':'#fff'; });
    };
    const showAppBody = (on)=>{
      $('#leftBody').classList.toggle('hidden', !on);
      $('#rightPanel').classList.toggle('hidden', !on);
    };

    // Toast helper
    const toast = (msg, ms=3500)=>{
      const t=$('#toast'); t.innerHTML=msg; t.classList.remove('hidden');
      clearTimeout(t._h); t._h=setTimeout(()=>t.classList.add('hidden'), ms);
    };

    // Debounce helper
    const debounce=(fn,ms)=>{let h;return(...args)=>{clearTimeout(h);h=setTimeout(()=>fn(...args),ms)}};

    // Search-as-you-type with graceful fallbacks
    const doSearch = async (q)=>{
      const sug = $('#sug');
      sug.innerHTML='';
      if(q.length<3){
        const div=document.createElement('div'); div.className='sug-empty';
        div.textContent='Tape au moins 3 caractères'; sug.appendChild(div);
        showAppBody(false);
        return;
      }

      // show spinner row
      const spin=document.createElement('div'); spin.className='sug-empty';
      spin.innerHTML='<span class="spinner"></span>Recherche…';
      sug.appendChild(spin);

      try{
        let hits=[];
        // 1) Try a hypothetical server-side search endpoint (if available on your UCD)
        let res = await fetch(`${API_BASE}/RCU_Fnac_2/search?email=${encodeURIComponent(q)}&limit=50`,{
          headers:{'X-API-KEY': API_KEY,'x-api-key':API_KEY,'Authorization':`Bearer ${API_KEY}`}
        });
        if(res.ok){
          const js = await res.json();
          hits = (js && (js.data||js.results||[])) || [];
        } else if(res.status===404){
          // 2) Fallback to list + client-side filter
          res = await fetch(`${API_BASE}/RCU_Fnac_2?limit=10000`,{headers:{'X-API-KEY': API_KEY,'x-api-key':API_KEY}});
          const js = await res.json();
          const arr = (js && js.data) ? js.data : [];
          hits = arr.filter(x=> (x.email||'').toLowerCase().includes(q)).slice(0,50);
        } else {
          throw new Error(`HTTP ${res.status}`);
        }

        sug.innerHTML='';
        if(!hits.length){
          const div=document.createElement('div'); div.className='sug-empty';
          div.textContent='Aucun résultat'; sug.appendChild(div);
          showAppBody(false); return;
        }
        hits.forEach(x=>{
          const div = document.createElement('div');
          div.textContent = `${x.firstName||''} ${x.lastName||''} — ${x.email||''}`;
          div.addEventListener('click', ()=>{
            sug.innerHTML='';
            loadRecord(x);
            $('#q').value = x.email||'';
            showAppBody(true);
          });
          sug.appendChild(div);
        });
      }catch(err){
        console.error(err);
        sug.innerHTML='';
        const div=document.createElement('div'); div.className='sug-empty';
        div.textContent='Erreur de recherche'; sug.appendChild(div);
        toast("Impossible de joindre l'API (CORS / réseau). Ouvre le fichier via un serveur local ou autorise le domaine dans CORS.");
        showAppBody(false);
      }
    };

    $('#q').addEventListener('input', debounce((e)=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q){ showAppBody(false); $('#sug').innerHTML=''; return; }
      doSearch(q);
    }, 250));

    // Populate UI
    function loadRecord(rec){
      $('#firstName').value = rec.firstName||'';
      $('#lastName').value  = rec.lastName||'';
      $('#email').value     = rec.email||'';
      $('#mobile').value    = rec.mobile||'';
      $('#favStore').value  = rec.Magasin_favori||'';
      $('#fid').value       = rec.Statut_Fidelite||'';
      $('#rfm').value       = rec.Statut_RFM||rec.RFM||'';
      $('#optEmail').value  = rec.optInEmail===true? 'Oui':'Non';
      $('#optSMS').value    = rec.optInSMS===true? 'Oui':'Non';
      $('#optPush').value   = rec.optInPush===true? 'Oui':'Non';

      $('#ca').textContent       = fmtEUR(rec.CA_Omnicanal_en);
      $('#classif').textContent  = rec.Classification_client||'';
      $('#city').textContent     = rec.city||'';
      $('#zip').textContent      = rec.zipCode||'';
      $('#dob').textContent      = rec.dateOfBirth||'';
      $('#storeId').textContent  = rec.Store_ID||'';

      const tbody = $('#purchases');
      tbody.innerHTML='';
      const items = Array.isArray(rec['3_derniers_produits_achetes'])?rec['3_derniers_produits_achetes']:[];
      items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${safe(it.Order_date)}</td>
          <td>${safe(it.product_name)}<div class="pill">SKU ${safe(it.sku)}</div></td>
          <td>${safe(it.category)}</td>
          <td>${safe(it.brand)}</td>
          <td>${safe(it.quantity)}</td>
          <td>${fmtEUR(it.line_total_ttc || it.unit_price_ttc)}</td>`;
        tbody.appendChild(tr);
      });

      setRO(true);
      $('#btnEdit').style.display='inline-block';
      $('#btnSave').style.display='none';
      $('#btnCancel').style.display='none';
    }

    function fmtEUR(v){
      if(v===undefined||v===null||v==='') return '—';
      const n = Number(v);
      if(Number.isNaN(n)) return String(v);
      return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(n);
    }
    function safe(v){ return (v===undefined||v===null)?'':String(v); }

    // Edit/Save profile (upsert via POST /RCU_Fnac_2)
    $('#btnEdit').addEventListener('click', ()=>{
      setRO(false);
      $('#btnEdit').style.display='none';
      $('#btnSave').style.display='inline-block';
      $('#btnCancel').style.display='inline-block';
    });
    $('#btnCancel').addEventListener('click', ()=>{
      setRO(true);
      $('#btnEdit').style.display='inline-block';
      $('#btnSave').style.display='none';
      $('#btnCancel').style.display='none';
    });
    $('#btnSave').addEventListener('click', async ()=>{
      const payload = {
        firstName: $('#firstName').value.trim(),
        lastName:  $('#lastName').value.trim(),
        email:     $('#email').value.trim(),
        mobile:    $('#mobile').value.trim(),
        Store_ID:  $('#storeId').textContent.trim(),
        city:      $('#city').textContent.trim(),
        zipCode:   $('#zip').textContent.trim(),
        optInEmail: $('#optEmail').value.toLowerCase()==='oui',
        optInSMS:   $('#optSMS').value.toLowerCase()==='oui',
        optInPush:  $('#optPush').value.toLowerCase()==='oui'
      };
      try{
        const res = await fetch(`${API_BASE}/RCU_Fnac_2`,{
          method:'POST',
          headers:{'Content-Type':'application/json','X-API-KEY':API_KEY,'x-api-key':API_KEY,'Authorization':`Bearer ${API_KEY}`},
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text();
          alert('Échec de la sauvegarde: '+t);
          return;
        }
        toast('Profil enregistré.');
        setRO(true);
        $('#btnEdit').style.display='inline-block';
        $('#btnSave').style.display='none';
        $('#btnCancel').style.display='none';
      }catch(e){ console.error(e); toast('Erreur réseau.'); }
    });

    // New contact bubble logic
    const bubble = $('#createBubble');
    const openBubble = ()=>{ bubble.classList.remove('hidden'); $('#cFirst').focus(); };
    const closeBubble = ()=>{ bubble.classList.add('hidden'); };

    $('#btnNew').addEventListener('click', ()=>{
      // Reset fields each open
      ['cFirst','cLast','cEmail','cMobile'].forEach(id=>$('#'+id).value='');
      openBubble();
    });
    $('#bubbleClose').addEventListener('click', closeBubble);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeBubble(); });
    document.addEventListener('click', (e)=>{ if(!bubble.classList.contains('hidden') && !bubble.contains(e.target) && e.target.id!=='btnNew'){ closeBubble(); }});

    // Create from bubble
    $('#bubbleCreate').addEventListener('click', async ()=>{
      const payload = {
        firstName: $('#cFirst').value.trim(),
        lastName:  $('#cLast').value.trim(),
        email:     $('#cEmail').value.trim(),
        mobile:    $('#cMobile').value.trim(),
        createdDate: new Date().toISOString()
      };
      if(!payload.email){ toast('Email requis.'); return; }
      try{
        const res = await fetch(`${API_BASE}/RCU_Fnac_2`,{
          method:'POST',
          headers:{'Content-Type':'application/json','X-API-KEY':API_KEY,'x-api-key':API_KEY,'Authorization':`Bearer ${API_KEY}`},
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text();
          toast('Création impossible: '+t);
          return;
        }
        toast('Contact créé.');
        closeBubble();
        $('#q').value = payload.email;
        doSearch(payload.email.toLowerCase());
      }catch(e){ console.error(e); toast('Erreur réseau.'); }
    });
  </script>
</body>
</html>
